/*
 * Venue Sorting and Mapping
 */

// Mapping
function clickEventHandler(marker, event, context)
{
    var map = $(this).gmap3("get")
    var infowindow = $(this).gmap3({get:{name: "infowindow"}});

    if(infowindow)
    {
        infowindow.open(map, marker);
        infowindow.setContent(context.data);
    }
    else
    {
        $(this).gmap3({infowindow:{anchor:marker, options:{content: context.data}}});
    }
}

function buildMap()
{
    console.log("buildMap");

    // Exit on Map Div Element Not Found
    if($('.map').length == 0)
    {
        return;
    }

    // Exit on No Data Found
    if($('.map').data('venues').length == 0)
    {
        return;
    }

    var venues = $('.map').data('venues');

    if(venues.length > 1)
    {
        $(".map").gmap3(
        {
            map:
            {
                options:
                {
                    maxZoom: 6,
                    minZoom: 2
                }
            },
            marker:
            {
                values: venues,
                options:
                {
                    icon: "http://maps.google.com/mapfiles/marker_green.png",
                    clickable: true
                },
                events:
                {
                    click: clickEventHandler
                }
            }
        }, "autofit");
    }
    else
    {
        $(".map").gmap3(
        {
            map:
            {
                options:
                {
                    maxZoom: 15,
                    minZoom: 6
                }
            },
            marker:
            {
                values: venues,
                options:
                {
                    icon: "http://maps.google.com/mapfiles/marker_green.png",
                    clickable: true
                },
                events:
                {
                    click: clickEventHandler
                }
            }
        }, "autofit");
    }
    
}

// Sorting
var options = { valueNames: ['name', 'description', 'category', 'country'] };
var venueList = new List('locations-list', options);

function filterList(event) 
{
    console.log("filterList");

    var target = event.target;
    var category = 'none';
    event.preventDefault();
    
    if(!$(target).hasClass('filter'))
    {
        target = $(target).parents('filter').first();
    }
    
    category = $(target).attr('data-category');
    venueList.filter(function(item)
    {
        if (category == 'none') return true;
        if ((item.values().category == category))
        {
            return true;
        }
        else
        {
            return false;
        }
    });
    buildMap();
}

// Init
$(document).ready(function()
{
    $('.btn.filter').click(filterList);
    buildMap();
});